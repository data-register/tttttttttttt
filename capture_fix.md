# Capture Module Fix
Фиксирани проблеми в capture модула за работа в Hugging Face Space:
- Подобрено записване на изображения първо в static директорията
- Добавена обработка на грешки при работа с OpenCV
- Оптимизиран /latest.jpg endpoint за директен достъп
- Добавени алтернативни пътища за запис при проблеми с права

# Интеграция на FFmpeg в PTZ Camera Control System

Тази документация описва как е интегриран FFmpeg в системата за контрол на PTZ камери за надеждно извличане на кадри от видео потоци.

## Общ преглед

FFmpeg е мощна библиотека за обработка на видео, която се използва в нашата система за извличане на кадри от RTSP и HLS потоци. Интеграцията осигурява стабилно и бързо извличане на кадри независимо от вида на потока или протокола.

## Изисквания

### Системни зависимости

- FFmpeg (инсталиран чрез apt в Docker образа)
- OpenCV (инсталиран чрез pip в requirements.txt)

### Python пакети

Следните Python пакети са необходими за интеграцията:

```
python-ffmpeg==1.0.16
ffmpeg-python==0.2.0
```

## Архитектура

### 1. FFmpeg Utilities (`modules/stream/ffmpeg_utils.py`)

Този модул съдържа ключовите функции за работа с FFmpeg:

- `check_ffmpeg_installed()`: Проверява дали FFmpeg е инсталиран и достъпен
- `capture_frame_from_stream()`: Извлича единичен кадър от поток чрез FFmpeg
- `get_frame_from_public_stream()`: Опростена функция специално за публични потоци
- `add_timestamp_to_frame()`: Добавя текуща дата/час върху кадъра

### 2. Кеш механизъм (`modules/stream/cache.py`)

Модулът за кеширане подобрява производителността чрез:

- Съхранение на кадри за определен период
- Намаляване натоварването на камерата и мрежата
- Автоматично обновяване при изтичане на кеша

### 3. API Интерфейс (`modules/stream/api.py`)

Предоставя крайни точки за:

- `/stream/snapshot`: Връща текущ кадър от потока (поддържа параметъра `force_refresh`)
- `/stream/view`: Страница за визуализация на потока с интерактивен интерфейс
- `/stream/cache`: Информация за състоянието на кеш системата
- `/stream/cache/clear`: Позволява изчистване на кеша

## Механизъм на работа

1. Когато се заяви кадър от потока, системата:
   - Първо проверява дали FFmpeg е инсталиран
   - После проверява дали има валиден кадър в кеша
   - Ако кадърът е изтекъл или е поискано принудително обновяване, извлича нов кадър
   - Запазва новия кадър в кеша за бъдещо използване

2. FFmpeg извличането работи чрез:
   - Изпълнение на FFmpeg команда за взимане на единичен кадър от потока
   - Запис на кадъра във временен файл
   - Зареждане на изображението с OpenCV
   - Добавяне на timestamp и друга информация

3. Резервен механизъм:
   - Ако FFmpeg не е наличен, системата генерира информативно изображение
   - Ако кадърът не може да бъде извлечен, системата показва диагностична информация

## Потребителски интерфейс

Потребителският интерфейс предоставя два начина за преглед на потока:

1. **Живо предаване**: Вграден iframe с HLS поток
2. **Единичен кадър**: Периодично обновяващо се изображение с два режима:
   - Стандартно обновяване (използва кеша)
   - Принудително обновяване (игнорира кеша)

## Настройка и конфигурация

### Docker

FFmpeg е включен в Docker образа чрез инсталация с apt:

```dockerfile
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    wget \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*
```

### Конфигурационни параметри

- Кеш конфигурация:
  - Максимална възраст на кадър: По подразбиране 5 секунди
  - Възможно е задаване на различно време за различни източници

- FFmpeg параметри:
  - Качество на изображението: `-q:v 2` (високо качество)
  - Брой кадри: `-frames:v 1` (само един кадър)
  - Таймаут: 10 секунди по подразбиране

## Безопасност и производителност

- Включени защити:
  - Безопасно показване на URL адреси (маскиране на пароли)
  - Таймаути за всички мрежови операции
  - Проверки за празни или невалидни изображения
  - Йерархия от резервни механизми

- Подобрения на производителността:
  - Интелигентен кеш механизъм
  - Минимизирани системни извиквания
  - Лимитирани мрежови заявки
  - Singleton дизайн за кеша

## Тестване

За тестване на FFmpeg интеграцията, използвайте:

1. Проверка на FFmpeg инсталацията: `/stream/info` ще покаже дали FFmpeg е наличен
2. Проверка на извличането на кадри: `/stream/snapshot` ще върне кадър или информация за грешка
3. Проверка на кеша: `/stream/cache` ще покаже текущото състояние на кеша

## Отстраняване на проблеми

### Често срещани проблеми и решения

1. **FFmpeg не е инсталиран**
   - Проверете че FFmpeg е инсталиран в контейнера
   - Изпълнете `ffmpeg -version` за проверка

2. **Не могат да се извлекат кадри**
   - Проверете URLs и мрежовата свързаност
   - Увеличете таймаута в `capture_frame_from_stream`
   - Проверете за firewall или мрежови рестрикции

3. **Лошо качество или бавно извличане**
   - Настройте параметрите за качество в FFmpeg командата
   - Увеличете таймаута
   - Намалете размера на извличаните кадри

## Заключение

Интеграцията на FFmpeg с кеш механизъм осигурява надеждно и оптимизирано решение за извличане на кадри от различни видео потоци. Системата автоматично се адаптира към наличните ресурси и осигурява плавно визуализиране на кадри от камерата независимо от средата на изпълнение.
